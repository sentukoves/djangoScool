use sm_sap_erp;
DECLARE @XmlWithDeclaration VARCHAR(MAX)= 
(select   top(1)            	 	
 ( 		SELECT 		
 p.RESERVING_OPERATION_GUID as reserving_operation_guid
  	  ,p.[RESERVING_OPERATION_IDACTION] as reserving_operation_idaction
	         ,p.[RESERVING_OPERATION_IDSTATE] as reserving_operation_idstate        ,p.[reserving_operation_subscriber_idsubscriber]       ,p.[act_id]       ,p.[act_idtype]       ,p.[RESERVING_OPERATION_DATETIME]       ,p.[act_datecreate]       ,p.[AUFNR]       ,p.[act_idzak]       ,p.[act_idpodr]       ,p.[act_idkur]       ,p.[act_idbudgetitem] 	  ,p.[act_idob_type]       , convert( varchar,convert(int ,p.act_ob_tek)) as act_ob_tek       , convert( varchar,convert(int ,p.act_ob)) as act_ob       ,p.[act_matzak]       ,p.[act_matpodr]       ,p.[act_ob_tek]       ,p.[act_contract]       ,p.[act_REGISTRATIONDATA_COMPANYNO]       ,p.[act_REGISTRATIONDATA_DT_REGISTRATION]       ,p.[act_KUDS_CONTRACT_TYPE_ID]       ,p.[act_KUDS_CONTRACT_TYPE_NAME]       ,p.[act_parent_contract]       ,p.[act_parent_REGISTRATIONDATA_COMPANYNO]       ,p.[act_parent_REGISTRATIONDATA_DT_REGISTRATION]       ,p.[act_parent_KUDS_CONTRACT_TYPE_ID]       ,p.[act_parent_KUDS_CONTRACT_TYPE_NAME]       ,p.[act_work_type]       ,p.[act_external_volume]       ,p.[reserving_operation_docnumbers_sbit]       ,p.[reserving_operation_docnumbers_rabota]       ,p.[Act_Cena]       ,p.[act_idsm]       ,p.[reserving_operation_docnumbers_spp]       ,p.[reserving_operation_docnumbers_viddvizh]       ,p.[Act_WithNDS] as act_withnds   , p.[Act_Name]             				from    [reserving_act_saperp_select] as p with (nolock)     	 				FOR XML PATH('HEADER'), TYPE     ),   					    ( SELECT  a.reserving_price_operation_guid,             a. reserving_price_idprice, a.reserving_price_ens_code ,         a.reserving_price_ispodr,  convert(varchar, convert(float, a.reserving_price_count)) as reserving_price_count,  a.reserving_price_mol, a.reserving_price_gmk3_id, a.reserving_price_gmk7_id,a.reserving_price_gmk7_number,        a.reserving_doc_reserv, a.reserving_doc_material, a.material_rs_pos     	 FROM [reserving_material_select] as a      		 WHERE a.reserving_price_operation_guid = s.reserving_operation_guid     			 FOR XML PATH('MATERIAL'), TYPE), 	 (SELECT  b.reserving_operation_guid,        b.AUFNR,  	 b.Dat_Num,  	 b.Spr_obosn,  		 b.Dat_Name,  		  b.sm_calculation_data_dat_ed,      convert(varchar, convert(float, b.dat_kol)) as dat_kol,  b.Dat_nch, b.dat_idsm     FROM [reserving_dat_select] as b      	 WHERE b.reserving_operation_guid = s.reserving_operation_guid       	 FOR XML PATH('DAT'), TYPE     )   		    from    [reserving_act_saperp_select] as s with (nolock)  			 FOR XML PATH('row'));        DECLARE @count integer =  (  SELECT count(@XmlWithDeclaration) )   if @count > 0 BEGIN 	SELECT CAST (replace(replace(@XmlWithDeclaration, '&lt;', '<'),'&gt;', '>') AS XML) as BOXML END ELSE 	select * from reserving_act_saperp_select p where p.RESERVING_OPERATION_GUID = '99999'
